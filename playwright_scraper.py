#!/usr/bin/env python3
"""
Playwright ile GER√áEK Trendyol Yorumlarƒ± √áeker
Chrome kurulu olmasa bile √ßalƒ±≈üƒ±r!
"""

from playwright.sync_api import sync_playwright
import json
import re
import time
from datetime import datetime
from database import SessionLocal, Product, ProductReview
from turkish_review_ai import TurkishReviewAI

class PlaywrightScraper:
    """Playwright ile ger√ßek Trendyol yorumlarƒ± √ßeker"""

    def __init__(self):
        self.session = SessionLocal()
        self.ai = TurkishReviewAI()

    def extract_product_id(self, url):
        """URL'den product ID √ßƒ±kar"""
        patterns = [
            r'-p-(\d+)',
            r'/product/(\d+)',
            r'productId=(\d+)'
        ]
        for pattern in patterns:
            match = re.search(pattern, url)
            if match:
                return match.group(1)
        return None

    def scrape_with_playwright(self, product_id):
        """Playwright ile yorumlarƒ± √ßek"""

        product = self.session.query(Product).filter_by(id=product_id).first()
        if not product:
            print(f"‚ùå √úr√ºn bulunamadƒ±: {product_id}")
            return False

        print("\n" + "="*60)
        print("üé≠ PLAYWRIGHT ƒ∞LE GER√áEK YORUM √áEKME")
        print("="*60)
        print(f"üì¶ √úr√ºn: {product.name[:50]}...")
        print(f"üîó URL: {product.product_url or product.url}")

        # Mevcut yorumlarƒ± temizle
        self.session.query(ProductReview).filter_by(product_id=product_id).delete()
        self.session.commit()

        with sync_playwright() as p:
            # Browser ba≈ülat (headless modda)
            print("üåê Browser ba≈ülatƒ±lƒ±yor...")
            browser = p.chromium.launch(
                headless=True,
                args=[
                    '--disable-blink-features=AutomationControlled',
                    '--disable-features=IsolateOrigins,site-per-process',
                    '--no-sandbox',
                    '--disable-dev-shm-usage'
                ]
            )

            # Yeni sayfa a√ß
            context = browser.new_context(
                viewport={'width': 1920, 'height': 1080},
                user_agent='Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
                locale='tr-TR'
            )

            page = context.new_page()

            # Anti-detection JavaScript ekle
            page.add_init_script("""
                Object.defineProperty(navigator, 'webdriver', {
                    get: () => undefined
                });
            """)

            reviews = []

            try:
                print(f"üìÑ Sayfa a√ßƒ±lƒ±yor: {product.product_url or product.url}")
                page.goto(product.product_url or product.url, wait_until='domcontentloaded')

                # Sayfa y√ºklenmesini bekle
                page.wait_for_timeout(3000)

                # Cookie banner'ƒ± kapat
                try:
                    page.click('#onetrust-accept-btn-handler', timeout=3000)
                    print("‚úì Cookie banner kapatƒ±ldƒ±")
                except:
                    pass

                # √ñnce sayfadaki initial state'ten yorumlarƒ± al
                try:
                    # JavaScript'ten veri √ßek
                    initial_state = page.evaluate("""
                        () => {
                            if (window.__PRODUCT_DETAIL_APP_INITIAL_STATE__) {
                                return window.__PRODUCT_DETAIL_APP_INITIAL_STATE__;
                            }
                            return null;
                        }
                    """)

                    if initial_state:
                        # Yorumlarƒ± bul
                        if 'product' in initial_state:
                            product_data = initial_state['product']

                            # ratingSummary i√ßindeki yorumlar
                            if 'ratingSummary' in product_data and 'reviews' in product_data['ratingSummary']:
                                review_list = product_data['ratingSummary']['reviews']
                                print(f"‚úì Sayfadan {len(review_list)} yorum bulundu")

                                for r in review_list:
                                    if r.get('comment'):
                                        reviews.append({
                                            'reviewer_name': r.get('userFullName', 'Trendyol M√º≈üterisi'),
                                            'reviewer_verified': True,
                                            'rating': r.get('rate', 5),
                                            'review_text': r.get('comment', ''),
                                            'review_date': datetime.now(),
                                            'helpful_count': r.get('helpfulCount', 0)
                                        })
                except Exception as e:
                    print(f"‚ö†Ô∏è Initial state okunamadƒ±: {e}")

                # Eƒüer initial state'ten yorum bulunamadƒ±ysa DOM'dan √ßek
                if not reviews:
                    print("üîç DOM'dan yorum aranƒ±yor...")

                    # Yorumlar b√∂l√ºm√ºne scroll
                    page.evaluate("window.scrollTo(0, document.body.scrollHeight / 2)")
                    page.wait_for_timeout(2000)

                    # T√ºm yorumlarƒ± g√∂ster butonuna tƒ±kla
                    try:
                        page.click("button:has-text('T√ºm Yorumlarƒ± G√∂r')", timeout=3000)
                        page.wait_for_timeout(2000)
                        print("‚úì T√ºm yorumlar a√ßƒ±ldƒ±")
                    except:
                        pass

                    # Yorumlarƒ± topla
                    review_elements = page.query_selector_all("div.comment-text, div.pr-xc-w, div[class*='review']")

                    for elem in review_elements[:50]:  # Max 50 yorum
                        try:
                            text = elem.inner_text()
                            if text and len(text) > 10:
                                reviews.append({
                                    'reviewer_name': 'Trendyol M√º≈üterisi',
                                    'reviewer_verified': True,
                                    'rating': 5,
                                    'review_text': text,
                                    'review_date': datetime.now(),
                                    'helpful_count': 0
                                })
                        except:
                            continue

                # API'den de deneyelim
                if not reviews:
                    product_trendyol_id = self.extract_product_id(product.product_url or product.url)
                    if product_trendyol_id:
                        print(f"üì° API'den yorumlar √ßekiliyor (ID: {product_trendyol_id})...")

                        api_url = f"https://public.trendyol.com/discovery-web-webproductgw-santral/api/review/{product_trendyol_id}?page=0&size=50"

                        response = page.evaluate(f"""
                            async () => {{
                                try {{
                                    const response = await fetch('{api_url}', {{
                                        headers: {{
                                            'Accept': 'application/json',
                                            'Accept-Language': 'tr-TR,tr;q=0.9'
                                        }}
                                    }});
                                    return await response.json();
                                }} catch (e) {{
                                    return null;
                                }}
                            }}
                        """)

                        if response and 'result' in response:
                            if 'productReviews' in response['result'] and 'content' in response['result']['productReviews']:
                                api_reviews = response['result']['productReviews']['content']
                                print(f"‚úì API'den {len(api_reviews)} yorum alƒ±ndƒ±")

                                for r in api_reviews:
                                    if r.get('comment'):
                                        reviews.append({
                                            'reviewer_name': r.get('userFullName', 'Trendyol M√º≈üterisi'),
                                            'reviewer_verified': r.get('verifiedPurchase', False),
                                            'rating': r.get('rate', 5),
                                            'review_text': r.get('comment', ''),
                                            'review_date': datetime.now(),
                                            'helpful_count': r.get('helpfulCount', 0)
                                        })

            except Exception as e:
                print(f"‚ùå Hata: {e}")
            finally:
                browser.close()

            if reviews:
                print(f"\nüíæ {len(reviews)} GER√áEK yorum kaydediliyor...")

                # Yorumlarƒ± kaydet
                for review_data in reviews:
                    # AI analizi
                    analysis = self.ai.analyze_review(review_data['review_text'])

                    review = ProductReview(
                        product_id=product_id,
                        reviewer_name=review_data['reviewer_name'],
                        reviewer_verified=review_data['reviewer_verified'],
                        rating=review_data['rating'],
                        review_title='',
                        review_text=review_data['review_text'],
                        review_date=review_data['review_date'],
                        helpful_count=review_data['helpful_count'],
                        sentiment_score=analysis['sentiment_score'],
                        key_phrases=analysis['key_phrases'],
                        purchase_reasons=analysis['purchase_reasons'],
                        pros=analysis['pros'],
                        cons=analysis['cons']
                    )
                    self.session.add(review)

                self.session.commit()

                # Analiz g√∂ster
                self._show_analysis(product.name, reviews)

                print("\n" + "="*60)
                print(f"‚úÖ {len(reviews)} GER√áEK YORUM KAYDEDƒ∞LDƒ∞!")
                print("‚úÖ PLAYWRIGHT ƒ∞LE BA≈ûARILI!")
                print("="*60)
                return True
            else:
                print("\n" + "="*60)
                print("‚ùå YORUM √áEKƒ∞LEMEDƒ∞!")
                print("‚ùå FALLBACK KULLANILMADI!")
                print("="*60)
                return False

    def _show_analysis(self, product_name, reviews):
        """Yorum analizini g√∂ster"""

        reviews_for_ai = [
            {
                'text': r['review_text'],
                'rating': r['rating'],
                'verified': r['reviewer_verified'],
                'helpful_count': r['helpful_count']
            }
            for r in reviews
        ]

        analysis = self.ai.analyze_bulk_reviews(reviews_for_ai)

        print("\n" + "="*60)
        print(f"üìä {product_name[:40]}... GER√áEK YORUM ANALƒ∞Zƒ∞")
        print("="*60)

        print(f"\nüìà ƒ∞STATƒ∞STƒ∞KLER:")
        print(f"  ‚Ä¢ Toplam Yorum: {analysis['total_reviews']}")
        print(f"  ‚Ä¢ Ortalama Duygu: {analysis['average_sentiment']:.2f}")
        print(f"  ‚Ä¢ Tavsiye Skoru: {analysis['recommendation_score']:.1f}/100")

        print(f"\nüõí NEDEN 1. SIRADA:")
        for reason, count in analysis['top_purchase_reasons'][:5]:
            print(f"  ‚Ä¢ {reason}: {count} ki≈üi")

        print(f"\n‚úÖ ARTILAR:")
        for pro, count in analysis['top_pros'][:5]:
            print(f"  ‚Ä¢ {pro}: {count} kez")

        if analysis['top_cons']:
            print(f"\n‚ùå EKSƒ∞LER:")
            for con, count in analysis['top_cons'][:3]:
                print(f"  ‚Ä¢ {con}: {count} kez")


if __name__ == "__main__":
    print("="*60)
    print("üé≠ PLAYWRIGHT SCRAPER")
    print("‚úÖ Chrome gerekmez - Chromium kullanƒ±r")
    print("‚úÖ Headless modda √ßalƒ±≈üƒ±r")
    print("‚ùå FALLBACK YOK!")
    print("="*60)

    scraper = PlaywrightScraper()

    # ƒ∞lk √ºr√ºn√º test et
    first_product = scraper.session.query(Product).first()
    if first_product:
        scraper.scrape_with_playwright(first_product.id)
    else:
        print("‚ùå √úr√ºn bulunamadƒ±")

    scraper.session.close()